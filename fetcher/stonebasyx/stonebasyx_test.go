package stonebasyx

import (
	"os"
	"testing"

	"github.com/asjoyner/slabfinder"
	"github.com/google/go-cmp/cmp"
)

func TestParseHTML(t *testing.T) {
	type test struct {
		name  string
		input string // path to an html file
		url   string // URL the page was fetched from
		want  []slabfinder.Slab
	}

	tests := []test{
		{
			name:  "Classic",
			input: "testdata/classic.html",
			url:   classic,
			want: []slabfinder.Slab{
				{
					Color:     "Black, White",
					Count:     2,
					Lot:       "022632",
					Bundle:    "127760",
					Finish:    slabfinder.Polished,
					Thickness: 3.0,
					Length:    132.5,
					Width:     78.5,
					Vendor:    slabfinder.StoneBasyx,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-104-127760-MAORI%20-%203.00%20CM%20-%20022632%20-%20127760.JPEG",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "102",
					Bundle:    "13021",
					Width:     77.5,
					Length:    119,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13021-MAORI_Bund_13021_BLK_102_3cm_Premium_pic_34775.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "17899",
					Bundle:    "1789939",
					Width:     77.5,
					Length:    129.5,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-66-210783239-MAORI%20POLISHED_block017899%20%20%20%20_bundle210783239_3CM.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "17899",
					Bundle:    "1789941",
					Width:     75.5,
					Length:    129,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-66-210783241-MAORI%20POLISHED_block017899%20%20%20%20_bundle210783241_3CM.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "102",
					Bundle:    "13026",
					Width:     77.5,
					Length:    119.5,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13026-MAORI_Bund_13026_BLK_102_3cm_Premium_pic_34871.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "07",
					Bundle:    "11348",
					Width:     76.5,
					Length:    131.5,
					Count:     6,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-270-11348-MAORI%203CM%20-%20SLABS%2009-14%20-%20BLK%20204.jpeg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "20411",
					Bundle:    "145807",
					Width:     70.5,
					Length:    126,
					Count:     4,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-100-145807-COPACABANA%20-%203CM%20-%20BLOCK%2020411.%20-%20SLABS%2016%20TO%2022.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "102",
					Bundle:    "13020",
					Width:     77.5,
					Length:    119,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13020-MAORI_Bund_13020_BLK_102_3cm_Premium_pic_34780.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "102",
					Bundle:    "13025",
					Width:     77.5,
					Length:    119,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13025-MAORI_Bund_13025_BLK_102_3cm_Premium_pic_34869.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "20411",
					Bundle:    "145809",
					Width:     71,
					Length:    126,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-100-145809-COPACABANA%20-%203CM%20-%20BLOCK%2020411.%20-%20SLABS%2023%20TO%2030.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "021700",
					Bundle:    "119453",
					Width:     75,
					Length:    124,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-104-119453-COPACABANA%20-%203.00%20CM%20-%20021700%20-%20119453.JPEG",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "102",
					Bundle:    "13021",
					Width:     77.5,
					Length:    119,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13021-MAORI_Bund_13021_BLK_102_3cm_Premium_pic_34775.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "17899",
					Bundle:    "1789939",
					Width:     77.5,
					Length:    129.5,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-66-210783239-MAORI%20POLISHED_block017899%20%20%20%20_bundle210783239_3CM.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "17899",
					Bundle:    "1789940",
					Width:     75.5,
					Length:    129.5,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-66-210783240-MAORI%20POLISHED_block017899%20%20%20%20_bundle210783240_3CM.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "75",
					Bundle:    "7507",
					Width:     74,
					Length:    123,
					Count:     5,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-267-007-MAORI%203cm%20Block%2075%20Slab%20033-037.JPG",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "75",
					Bundle:    "7508",
					Width:     74,
					Length:    123,
					Count:     5,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-267-008-MAORI%203cm%20Block%2075%20Slab%20038-042.JPG",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "20411",
					Bundle:    "145806",
					Width:     65.5,
					Length:    125.5,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-100-145806-COPACABANA%20-%203CM%20-%20BLOCK%2020411.%20-%20SLABS%2011%20TO%2015.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "000755",
					Bundle:    "3369",
					Width:     79.5,
					Length:    131.5,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-104-3369-Copacabana%20bundle%203369.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "102",
					Bundle:    "13022",
					Width:     77.5,
					Length:    119,
					Count:     3,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13022-MAORI_Bund_13022_BLK_102_3cm_Premium_pic_34786.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "27",
					Bundle:    "8404",
					Width:     78,
					Length:    120,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-8404-MAORI_Bund_8404_BLK_27_3cm_Premium_pic0.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "20411",
					Bundle:    "145806",
					Width:     65.5,
					Length:    125.5,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-100-145806-COPACABANA%20-%203CM%20-%20BLOCK%2020411.%20-%20SLABS%2011%20TO%2015.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "9061",
					Bundle:    "14991",
					Width:     78.5,
					Length:    125,
					Count:     7,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/712-45-14991-MAORI%203CM%2014991.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "9061",
					Bundle:    "14993",
					Width:     78,
					Length:    124.5,
					Count:     7,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/712-45-14993-MAORI%203CM%2014993.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "108",
					Bundle:    "13384",
					Width:     77.5,
					Length:    132,
					Count:     6,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13384-MAORI_Bund_13384_BLK_SKY108_3cm_Premium_pic_35507.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "108",
					Bundle:    "13387",
					Width:     77.5,
					Length:    131.5,
					Count:     6,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13387-MAORI_Bund_13387_BLK_SKY108_3cm_Premium_pic_35513.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "108",
					Bundle:    "13385",
					Width:     77.5,
					Length:    132,
					Count:     3,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13385-MAORI_Bund_13385_BLK_SKY108_3cm_Premium_pic_35509.jpg",
					URL:       classic,
				},
				{
					Color:     "Black, White",
					Finish:    1,
					Thickness: 3,
					Lot:       "102",
					Bundle:    "13021",
					Width:     77.5,
					Length:    119,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-115-13021-MAORI_Bund_13021_BLK_102_3cm_Premium_pic_34775.jpg",
					URL:       classic,
				},
			},
		},
		{
			name:  "Honed",
			input: "testdata/honed.html",
			url:   honed,
			want: []slabfinder.Slab{
				{
					Color:     "Black, White",
					Finish:    3,
					Thickness: 3,
					Lot:       "38651",
					Bundle:    "358910",
					Width:     77.5,
					Length:    127.5,
					Count:     6,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/690-2-358910-BD%20358910%20BLK038651%20MAORI%20HONED%20SPECIAL.jpg",
					URL:       honed,
				},
				{
					Color:     "Black, White",
					Finish:    3,
					Thickness: 3,
					Lot:       "38651",
					Bundle:    "358911",
					Width:     77.5,
					Length:    127.5,
					Count:     5,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/690-2-358911-BD%20358911%20BLK038651%20MAORI%20HONED%20SPECIAL.jpg",
					URL:       honed,
				},
				{
					Color:     "Black, White",
					Finish:    3,
					Thickness: 3,
					Lot:       "38651",
					Bundle:    "358908",
					Width:     77.5,
					Length:    126.5,
					Count:     6,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/690-2-358908-BD%20358908%20BLK038651%20MAORI%20HONED%20SPECIAL.jpg",
					URL:       honed,
				},
				{
					Color:     "Black, White",
					Finish:    3,
					Thickness: 3,
					Lot:       "38651",
					Bundle:    "358909",
					Width:     77.5,
					Length:    127.5,
					Count:     6,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/690-2-358909-BD%20358909%20BLK038651%20MAORI%20HONED%20SPECIAL.jpg",
					URL:       honed,
				},
				{
					Color:     "Black, White",
					Finish:    3,
					Thickness: 3,
					Lot:       "38651",
					Bundle:    "358912",
					Width:     77.5,
					Length:    127.5,
					Count:     5,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/690-2-358912-BD%20358912%20BLK038651%20MAORI%20HONED%20SPECIAL.jpg",
					URL:       honed,
				},
				{
					Color:     "Black, White",
					Finish:    3,
					Thickness: 3,
					Lot:       "22224",
					Bundle:    "81534",
					Width:     77,
					Length:    133,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-1-81534-SILVER%20GRAY%203CM%20-%20022224%20-%2081534.JPEG",
					URL:       honed,
				},
				{
					Color:     "Black, White",
					Finish:    3,
					Thickness: 3,
					Lot:       "22224",
					Bundle:    "81534",
					Width:     77,
					Length:    133,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/536-1-81534-SILVER%20GRAY%203CM%20-%20022224%20-%2081534.JPEG",
					URL:       honed,
				},
			},
		},
		{
			name:  "Leather",
			input: "testdata/leather.html",
			url:   leather,
			want: []slabfinder.Slab{
				{
					Color:     "Black",
					Finish:    2,
					Thickness: 3,
					Lot:       "9061",
					Bundle:    "14994",
					Width:     77.5,
					Length:    125,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/712-45-14994-MAORI%203CM%2014994.jpg",
					URL:       leather,
				},
				{
					Color:     "Black",
					Finish:    2,
					Thickness: 3,
					Lot:       "9061",
					Bundle:    "14995",
					Width:     77,
					Length:    125,
					Count:     2,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/712-45-14995-MAORI%203CM%2014995.jpg",
					URL:       leather,
				},
				{
					Color:     "Black",
					Finish:    2,
					Thickness: 3,
					Lot:       "9062",
					Bundle:    "15463",
					Width:     68.5,
					Length:    131,
					Count:     6,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/712-45-15463-MAORI%203CM%2015463.jpg",
					URL:       leather,
				},
				{
					Color:     "Black",
					Finish:    2,
					Thickness: 3,
					Lot:       "9062",
					Bundle:    "15460",
					Width:     73,
					Length:    131,
					Count:     4,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/712-45-15460-MAORI%203CM%2015460.jpg",
					URL:       leather,
				},
				{
					Color:     "Black",
					Finish:    2,
					Thickness: 3,
					Lot:       "9061",
					Bundle:    "14996",
					Width:     77,
					Length:    125.5,
					Count:     3,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/712-45-14996-MAORI%203CM%2014996.jpg",
					URL:       leather,
				},
				{
					Color:     "Black",
					Finish:    2,
					Thickness: 3,
					Lot:       "9061",
					Bundle:    "14995",
					Width:     77,
					Length:    125,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/712-45-14995-MAORI%203CM%2014995.jpg",
					URL:       leather,
				},
				{
					Color:     "Black",
					Finish:    2,
					Thickness: 3,
					Lot:       "9062",
					Bundle:    "15462",
					Width:     70.5,
					Length:    130.5,
					Count:     1,
					Vendor:    1,
					Photo:     "https://www.stonebasyx.com/_siteadmin2015/bundlepics/712-45-15462-MAORI%203CM%2015462.jpg",
					URL:       leather,
				},
			},
		},
	}

	for _, tc := range tests {
		page, err := os.ReadFile(tc.input)
		if err != nil {
			t.Errorf("%s: %s", tc.name, err)
			continue
		}

		got, err := parseHTML(page, tc.url)
		if err != nil {
			t.Errorf("%s: parsing %s: %s", tc.name, tc.input, err)
			continue
		}

		if diff := cmp.Diff(tc.want, got); diff != "" {
			t.Errorf("%s:\n%s", tc.name, diff)
			continue
		}
	}
	return
}
